
---

# Specification: The Integration Panel

## 1. High-Level Summary
This specification defines the **"Integration Panel"**, a dedicated UI view that serves as the final step in an automated workflow. Its purpose is to act as a clean and focused "launchpad" for the user to review, validate, and take manual ownership of the code generated by the AI in its isolated worktree.

The panel's primary function is to bridge the gap between automated generation and user-controlled validation. It achieves this by providing a single, powerful action: `[ ðŸš€ Open Terminal in Worktree ]`. This action gives the user an interactive terminal scoped directly to the correct worktree, empowering them to run tests, start a dev server, or perform any other validation task before committing the code.

## 2. Core Data Contracts
The Integration Panel is triggered and populated by a specific message from the Extension Host.

```typescript
/**
 * The message sent from the Extension Host to the WebView to signal that a task
 * is complete and the Integration Panel should be shown.
 */
export interface TaskReadyForIntegrationMessage {
  command: 'taskReadyForIntegration';
  payload: {
    /** The unique ID of the completed session. */
    sessionId: string;
    /** The name of the Git branch in the completed worktree. */
    branchName: string;
    /** A pre-populated, multi-line commit message generated by the AI. */
    commitMessage: string;
    /** A list of files that were created or modified. */
    changedFiles: string[];
  };
}

/**
 * The message sent from the WebView to the Extension Host when the user
 * clicks the primary action button.
 */
export interface OpenTerminalInWorktreeMessage {
  command: 'openTerminalInWorktree';
  payload: {
    /** The sessionId is sent back to the backend to identify the correct worktree path. */
    sessionId: string;
  };
}
```

## 3. Component Specification

### Component: IntegrationPanel (Svelte)
*   **Architectural Role:** UI Component (View)
*   **Core Responsibilities:**
    *   Display the details of the completed task (branch name, changed files).
    *   Present a pre-populated commit message in a read-only text area.
    *   Render the primary call-to-action button: `[ ðŸš€ Open Terminal in Worktree ]`.
    *   Provide secondary user-controlled actions for the final commit and merge step.
    *   Emit a message to the Extension Host when the primary action button is clicked.

*   **Public API (Svelte Component Signature):**
    ```svelte
    <!-- IntegrationPanel.svelte -->
    <script lang="ts">
      import { createEventDispatcher } from 'svelte';
      import type { TaskReadyForIntegrationMessage } from './types';

      /**
       * The details of the completed task, passed in as a prop.
       */
      export let task: TaskReadyForIntegrationMessage['payload'];

      const dispatch = createEventDispatcher();

      function openTerminal() {
        dispatch('openTerminal', { sessionId: task.sessionId });
      }
    </script>

    <!-- The component will render the UI based on the `task` prop -->
    ```

*   **Detailed Behavioral Logic (The Algorithm):**
    1.  The component is rendered when the Extension Host sends a `taskReadyForIntegration` message. The message's `payload` is passed as the `task` prop.
    2.  **Information Display:** The component renders the `task.branchName` and the list of `task.changedFiles` in a clear, read-only format.
    3.  **Commit Message:** The `task.commitMessage` is displayed within a `<textarea>` element.
    4.  **Primary Action:** The main user action is a prominent button with the text `[ ðŸš€ Open Terminal in Worktree ]`.
        a.  When this button is clicked, it calls the `openTerminal` function.
        b.  The `openTerminal` function dispatches an `openTerminal` event, which sends an `OpenTerminalInWorktreeMessage` to the Extension Host. The payload includes the `sessionId` so the backend knows which worktree directory to open.
    5.  **Backend Logic for `openTerminalInWorktree`:**
        a.  The `EventHandler` in the Extension Host receives this message.
        b.  It looks up the `WorktreeSession` using the `sessionId`.
        c.  It uses the `vscode.window.createTerminal()` API. Crucially, it provides the `cwd` (current working directory) option in the terminal's creation options, setting it to the absolute path of the worktree (`session.worktreePath`).
        d.  It also sets the terminal's `name` to the task's branch name for easy identification.
    6.  **Final Actions:** The panel will also display a `[ âœ… Commit, Merge & Push ]` button. As per the architectural mandate, this is a user-only gate. Clicking it will send a `commitAndMerge` message to the backend, which will then execute the necessary Git commands to finalize the work.

*   **Mandatory Testing Criteria:**
    *   **Rendering:** A component test must verify that given a `task` prop, the `branchName` and `commitMessage` are correctly displayed in the rendered UI.
    *   **Event Emission:** A test must verify that clicking the `[ ðŸš€ Open Terminal in Worktree ]` button dispatches an `openTerminal` event with the correct `sessionId` in its payload.
    *   **Backend Logic (Integration Test):** A higher-level integration test (outside the scope of this component's unit test) must verify that receiving an `openTerminalInWorktree` message correctly calls the `vscode.window.createTerminal` function with a `cwd` option pointing to the expected worktree path. This fulfills **V1 Success Criterion 5.3**.